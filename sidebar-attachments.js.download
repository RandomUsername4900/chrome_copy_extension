(window.webpackJsonp=window.webpackJsonp||[]).push([["sidebar-attachments"],{"1iFO":function(e,t,n){"use strict";(function(e){n.d(t,"c",(function(){return a}));n.d(t,"b",(function(){return o}));n.d(t,"a",(function(){return r}));var c=n("8h+W");const s=Object(c.a)({FETCH_ENGAGEMENTS_WITH_ATTACHMENTS_V2_SUCCESS:"FETCH_ENGAGEMENTS_WITH_ATTACHMENTS_V2_SUCCESS",FETCH_ENGAGEMENTS_WITH_ATTACHMENTS_V2_STARTED:"FETCH_ENGAGEMENTS_WITH_ATTACHMENTS_V2_STARTED",FETCH_ENGAGEMENTS_WITH_ATTACHMENTS_V2_FAILED:"FETCH_ENGAGEMENTS_WITH_ATTACHMENTS_V2_FAILED"}),a=s.FETCH_ENGAGEMENTS_WITH_ATTACHMENTS_V2_SUCCESS,o=s.FETCH_ENGAGEMENTS_WITH_ATTACHMENTS_V2_STARTED,r=s.FETCH_ENGAGEMENTS_WITH_ATTACHMENTS_V2_FAILED;e&&e.exports&&(e.exports.default=Object.assign({},e.exports))}).call(this,n("OYux")(e))},hEB3:function(e,t,n){"use strict";n.r(t);var c=n("QgEn"),s=n("1V8t"),a=n("+Tc6"),o=n("Ly8s"),r=n("1iFO");function i(e){Object(o.b)(r.b,e).catch(e=>{setTimeout(()=>{throw e})})}var d=n("DxuW"),b=n("3Ajz"),h=n("Ld67"),p=n("xHov"),j=n("QYOI");var u={fetch:(e,t,n=0)=>Object(p.c)(`sales-views/v1/attachments/${e.toLowerCase()}/${t}`,{offset:n},e=>Object(j.fromJS)(e))},g=n("zl7W");const m={[g.b]:(e,t)=>{const n=t.get("offset"),c=t.get("objectType"),s=t.get("subjectId");u.fetch(c,s,n).then(e=>{Object(h.a)(g.c,{data:e,subjectId:s,objectType:c})}).catch(e=>{Object(h.a)(g.a,{error:e,subjectId:s,objectType:c})})}};Object(b.a)(Object(j.Map)(),m);var T=n("MQNR"),l=n("RRvD");const E=j.List.of(T.CONTACT,T.COMPANY,T.DEAL,T.TICKET);function O(e){return e.get("results").map(e=>e.getIn(["engagement","id"]))}var f=Object(d.a)({namespace:"ATTACHMENTS_BY_SUBJECT_ID",idIsValid:e=>E.includes(e)}).defineResponseTo(g.c,(e,{subjectId:t,objectType:n,data:c})=>{const s=O(c);return e.updateIn([n,t],(e=Object(j.Map)())=>e.set("hasMore",c.get("hasMore")).set("offset",c.get("offset")).update("results",(e=Object(j.Set)())=>e.concat(s)))}).defineResponseTo(g.a,(e,{subjectId:t,objectType:n,error:c})=>e.updateIn([n,t],(e=Object(j.Map)())=>e.set("error",c))).defineResponseTo(l.DELETE_TIMELINE_ENGAGEMENT,(e,{engagement:t,subjectId:n,objectType:c})=>{const s=t.getIn(["engagement","id"]);return e.updateIn([c,n],(e=Object(j.Map)())=>e.update("results",(e=Object(j.Set)())=>e.filterNot(e=>e===s)))}).defineResponseTo(l.ADD_ENGAGEMENT_WITH_ATTACHMENT,(e,{engagement:t,subjectId:n,objectType:c})=>{const s=t.getIn(["engagement","id"]);return e.updateIn([c,n],(e=Object(j.Map)())=>e.update("results",(e=Object(j.Set)())=>e.concat([s])))}).register();var A={fetch:(e,t,n)=>Object(p.c)(`sales-views/v2/attachments/by-object-type-id/${encodeURIComponent(e)}/${t}`,{offset:n},e=>Object(j.fromJS)(e))};const I={[r.b]:(e,t)=>{const n=t.get("offset"),c=t.get("objectType"),s=t.get("subjectId");A.fetch(c,s,n).then(e=>{Object(h.a)(r.c,{data:e,subjectId:s,objectType:c})}).catch(e=>{Object(h.a)(r.a,{error:e,subjectId:s,objectType:c})})}};Object(b.a)(Object(j.Map)(),I);var M=n("2h/E");function y(e){return e.get("results").map(e=>e.getIn(["objectId"]))}var S=Object(d.a)({namespace:"ATTACHMENTS_V2_BY_SUBJECT_ID",idIsValid:e=>!Object(M.a)(e)}).defineResponseTo(r.c,(e,{subjectId:t,objectType:n,data:c})=>{const s=y(c);return e.updateIn([n,t],(e=Object(j.Map)())=>e.set("hasMore",c.get("hasMore")).set("offset",c.get("offset")).update("results",(e=Object(j.Set)())=>e.concat(s)))}).defineResponseTo(r.a,(e,{subjectId:t,objectType:n,error:c})=>e.updateIn([n,t],(e=Object(j.Map)())=>e.set("error",c))).defineResponseTo(l.DELETE_TIMELINE_ENGAGEMENT,(e,{engagement:t,subjectId:n,objectType:c})=>{const s=t.getIn(["engagement","id"]);return e.updateIn([c,n],(e=Object(j.Map)())=>e.update("results",(e=Object(j.Set)())=>e.filterNot(e=>e===s)))}).defineResponseTo(l.ADD_ENGAGEMENT_WITH_ATTACHMENT,(e,{engagement:t,subjectId:n,objectType:c})=>{const s=t.getIn(["engagement","id"]);return e.updateIn([c,n],(e=Object(j.Map)())=>e.update("results",(e=Object(j.Set)())=>e.concat([s])))}).register(),_=n("c/Td"),C=n.n(_),N=n("E7+s"),R=n("Nw75"),H=n("Ktcs"),w=n("VfuR"),v=n.n(w),x=n("mEYk"),D=n.n(x),W=n("7ETf"),G=n.n(W),V=n("wZqr"),L=n.n(V),k=n("sl/w"),F=n("Tqy5"),B=n("tPYf"),q=n("mpvR"),z=n("cW8h"),U=n("FHeW"),P=n("afyC"),Y=n("folk"),J=n("lGhp"),Q=n("H90k"),K=n("bn2T"),$=n("fcqb"),Z=n("0xjy"),X=n("g+dq"),ee=n.n(X);const te=()=>{const[e,t]=Object(H.useState)(null);Object(H.useEffect)(()=>{ee.a.get("/data-privacy-settings/hub-settings").then(({gdprToggleEnabled:e,legalBasisRequirementEnabled:n})=>{t({gdprToggleEnabled:e,legalBasisRequirementEnabled:n})}).catch(e=>D.a.captureException(e))},[]);return e};var ne=n("78o1"),ce=n("Oc1M"),se=n.n(ce),ae=n("muUi"),oe=n("hEU+"),re=n("764V"),ie=n("P4dz"),de=n("DqRu"),be=n("hmaQ"),he=n("FeM/"),pe=n("GgP/"),je=n.n(pe),ue=n("zWK0");const ge=se()((e,t)=>e.toList().sortBy(e=>{const n=e.get("id");return t.get(n)&&t.get(n).first()&&t.get(n).first().getIn(["engagement","id"])}).reverse());class me extends ae.a{constructor(e){super(e);this.renderAttachment=this.renderAttachment.bind(this);this.handleAttachmentViewTracking=this.handleAttachmentViewTracking.bind(this)}componentDidMount(){je()().then(e=>{this.setState({auth:e})}).catch(e=>{setTimeout(()=>{throw e})})}getAttachmentsToRender(){const{attachments:e,engagementsByAttachmentId:t}=this.props;return ge(e,t)}handleAttachmentViewTracking(){Z.a.log("recordInteractions",{action:"view attachment from side card",objectType:this.props.objectType})}renderAttachment(e){let t;const{canView:n,canEditSubject:s,readOnly:a}=this.props,o=e.get("id");if(!this.props.engagementsByAttachmentId.get(o))return null;s&&!a&&(t=this.props.onRemoveAttachment);return Object(c.jsx)("span",{"data-test-id":"profile-card-file-attachment",children:Object(c.jsx)(ne.a,{attachment:e,optionRemoveWithModal:!0,removeModalDescription:this.props.removeModalDescription,onRemoved:t,hasInteractions:!0,canView:n,thumbnailUrlConfig:re.a,onNameClick:this.handleAttachmentViewTracking})},o)}renderList(){const e=this.getAttachmentsToRender();return e.isEmpty()?null:Object(c.jsx)(he.a,{children:Object(c.jsx)(be.a,{className:"p-left-1 p-top-2",childClassName:"p-bottom-2 attachments-line-height",children:e.toArray().map(this.renderAttachment)})})}renderShowMoreButton(){return this.props.engagementsWithAttachments.get("hasMore")&&this.props.engagementsWithAttachments.get("offset")?Object(c.jsx)(he.a,{children:this.renderShowMore()}):null}renderNoAttachments(){const{subject:e,engagementsWithAttachments:t,objectType:n}=this.props;if(this.getAttachmentsToRender().size||t.get("hasMore"))return null;const s=Object(ie.m)(e);return Object(c.jsx)(he.a,{children:Object(c.jsx)(k.a,{message:"cardEngagementAttachements.profileSidebarModule.noAttachments",options:{name:s,objectType:n.toLowerCase()}})})}renderShowMore(){return Object(c.jsx)(de.a,{onClick:this.props.onShowMore,use:"link","data-unit-test":"show-more",children:Object(c.jsx)(k.a,{message:"cardEngagementAttachements.profileSidebarModule.showMore"})},"show-more")}renderLoading(){return Object(c.jsx)(oe.a,{})}render(){return this.props.attachments?Object(c.jsxs)("div",{"data-selenium-test":"sidebar-attachments-card-content",children:[this.renderNoAttachments(),this.renderList(),this.renderShowMoreButton()]}):this.renderLoading()}}me.propTypes={canView:v.a.bool.isRequired,canEditSubject:v.a.bool.isRequired,attachments:C.a.orderedSet,engagementsByAttachmentId:C.a.map,engagementsWithAttachments:C.a.map,readOnly:v.a.bool.isRequired,onRemoveAttachment:v.a.func,objectType:B.b.isRequired,onShowMore:v.a.func,removeModalDescription:v.a.node,subject:B.a};var Te=Object(ue.a)(me);const le=e=>{const t=e&&e.get("attachments");return t?t.map(e=>e.get("id")).filter(G.a):null},Ee=({objectType:e,subjectId:t,engagementsByAttachmentId:n,engagementsWithAttachments:s,isEditable:o,onShowMore:r,subject:i,inRecord:d,attachments:b})=>{const[h,p]=Object(H.useState)(!1),u=te(),g=Object(H.useMemo)(()=>u&&u.gdprToggleEnabled&&Object(Q.b)(J.a.getContainer().get(),"file-manager-gdpr-delete"),[u]),m=Object(H.useCallback)(c=>{const s=n.get(c);return(null!=s?s.size:void 0)?s.forEach(n=>{const s=n.getIn(["engagement","type"]),o=n.getIn(["metadata","body"]),r=n.get("attachments").filter(e=>e.get("id")!==c);if(s!==K.NOTE||o||0!==r.size)return Object(M.a)(e)?P.f(n,Object(j.Map)({attachments:r})):$.c(n,n.set("attachments",r),Object(j.Map)({attachments:r.map(e=>e.get("id"))}));a.b(n).then(()=>{d&&a.c(n,e,t)}).catch(e=>{setTimeout(()=>{throw e})})}):null},[e,t,n,d]),T=Object(H.useCallback)(e=>{Object(q.b)("cardEngagementAttachements.attachmentOptions.deleteFailedAlert");D.a.captureException(e)},[]),l=Object(H.useCallback)(e=>{m(e)},[m]),E=Object(H.useCallback)(t=>{Z.a.log("recordInteractions",{action:"delete attachment from side card",objectType:e});if(!h)return l(t);const n=L()(l,t);return g?Object(U.a)(t).then(n).catch(T):Object(U.b)(t).then(n).catch(T)},[e,T,l,h,g]),O=({target:{checked:e}})=>{p(e)},f=()=>{const e=g?Object(c.jsx)(k.a,{message:"cardEngagementAttachements.attachmentOptions.gdprDeleteCheckboxDescription"}):Object(c.jsx)(k.a,{message:"cardEngagementAttachements.attachmentOptions.permanentlyDeleteCheckboxDescription"});return Object(c.jsx)(F.a,{"data-test-id":"permanent-delete-checkbox",onChange:O,children:e})};return Object(c.jsx)(Te,{attachments:b,engagementsByAttachmentId:n,engagementsWithAttachments:s,isEditable:o,objectType:e,onRemoveAttachment:E,onShowMore:r,removeModalDescription:f(),subject:i})};Ee.propTypes={attachments:v.a.instanceOf(j.OrderedSet),engagementsByAttachmentId:C.a.map,engagementsWithAttachments:C.a.map,inRecord:v.a.bool,isEditable:v.a.bool.isRequired,objectType:B.b.isRequired,onShowMore:v.a.func,subject:B.a,subjectId:v.a.string};var Oe=Object(s.connect)({attachments:{stores:[z.a,Y.a],deref({engagementsWithAttachments:e}){if(Object(N.d)(e))return R.b;const t=e.get("results");if(!t||!t.size)return Object(j.OrderedSet)();const n=Y.a.get(t.toList()).reduce((e,t)=>{const n=le(t);return n&&n.size?e.concat(n):e},Object(j.OrderedSet)()).filter(G.a);return 0===n.size?Object(j.OrderedSet)():z.a.get(n).filter(G.a)}},engagementsByAttachmentId:{stores:[Y.a],deref({engagementsWithAttachments:e}){if(Object(N.d)(e))return R.b;const t=e.get("results"),n=t?t.filter(G.a):t;return n&&n.size?Y.a.get(n).reduce((e,t)=>{const n=le(t);if(!n||!n.size)return e;n.forEach(n=>e=e.update(n,e=>{null==e&&(e=Object(j.Set)());return e.add(t)}));return e},Object(j.Map)()):Object(j.Map)()}}})(Ee),fe=n("8R4a");n.d(t,"fetchAttachments",(function(){return Ae}));n.d(t,"WEBPACK_3_FORCE_MODULE_IMPORT",(function(){return Me}));const Ae=({objectType:e,subjectId:t})=>{Object(M.a)(e)?a.d(Object(j.Map)({objectType:e,subjectId:t})):i(Object(j.Map)({objectType:e,subjectId:t}))};class Ie extends H.Component{constructor(...e){super(...e);this.handleShowMore=()=>{const{objectType:e,subjectId:t,engagementsWithAttachments:n}=this.props,c=n.get("offset");Object(M.a)(this.props.objectType)?a.d(Object(j.Map)({objectType:e,subjectId:t,offset:c})):i(Object(j.Map)({objectType:e,subjectId:t,offset:c}))}}componentDidMount(){Ae({objectType:this.props.objectType,subjectId:this.props.subjectId})}componentDidUpdate(e){e.subjectId===this.props.subjectId&&e.objectType===this.props.objectType||Ae({objectType:this.props.objectType,subjectId:this.props.subjectId})}render(){const{subject:e,inRecord:t,isEditable:n,objectType:s,engagementsWithAttachments:a,subjectId:o,enableDnd:r}=this.props;return e?Object(N.d)(a)?Object(c.jsx)(oe.a,{}):Object(c.jsx)(Oe,{engagementsWithAttachments:a,inRecord:t,isEditable:n,objectType:s,onShowMore:this.handleShowMore,subject:e,subjectId:o,provideDndContext:!r}):null}}Ie.propTypes={enableDnd:v.a.bool,engagementsWithAttachments:C.a.map,isEditable:v.a.bool.isRequired,inRecord:v.a.bool,objectType:B.b.isRequired,subject:B.a,subjectId:v.a.string.isRequired};const Me=1;t.default=Object(s.connect)({subject:fe.a,engagementsWithAttachments:{stores:[f,S],deref({objectType:e,subjectId:t}){const n=Object(M.a)(e)?f.get(e):S.get(e);return Object(N.d)(n)||!n.get(t)?R.b:n.get(t)||Object(j.Map)()}}})(Ie)},"hEU+":function(e,t,n){"use strict";var c=n("QgEn"),s=n("LTV0"),a=n("FeM/");const o="SidebarLoading",r={minHeight:s.a.propTypes.minHeight},i={minHeight:200},d=({minHeight:e})=>Object(c.jsx)(a.a,{children:Object(c.jsx)(s.a,{grow:!0,minHeight:e})});d.displayName=o;d.propTypes=r;d.defaultProps=i;var b=d;n.d(t,"a",(function(){return b}))}}]);
//# sourceMappingURL=sidebar-attachments.js.map
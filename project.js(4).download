!function(e){var t={};function s(r){if(t[r])return t[r].exports;var n=t[r]={i:r,l:!1,exports:{}};e[r].call(n.exports,n,n.exports,s);n.l=!0;return n.exports}var r=[{name:"head-dlb/bundle.production.js",path:"head-dlb/static-1.368/bundle.production.js",ids:{}},{name:"hubspot-dlb/bundle.production.js",path:"hubspot-dlb/static-1.427/bundle.production.js",ids:{enviro:1}}];s.dlbpr=function(e,t){var n=r[e];if(!n.r){n.r=window["__webpack_require_"+n.name+"__"];if(!n.r)throw new Error("dlb "+n.name+" not loaded");n.r.linkDlb(s,n.ids)}return n.r(t)};s.m=e;s.c=t;s.d=function(e,t,r){s.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})};s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"});Object.defineProperty(e,"__esModule",{value:!0})};s.t=function(e,t){1&t&&(e=s(e));if(8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);s.r(r);Object.defineProperty(r,"default",{enumerable:!0,value:e});if(2&t&&"string"!=typeof e)for(var n in e)s.d(r,n,function(t){return e[t]}.bind(null,n));return r};s.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};s.d(t,"a",t);return t};s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)};s.p="//static.hsappstatic.net/live-notifications-embed/static-1.1809/";s(s.s=44)}([function(e,t,s){e.exports=s.dlbpr(1,9)},function(e,t,s){e.exports=s.dlbpr(0,9)},function(e,t,s){e.exports=s.dlbpr(0,5)},function(e,t,s){e.exports=s.dlbpr(0,10)},function(e,t,s){e.exports=s.dlbpr(1,57)},function(e,t,s){e.exports=s.dlbpr(1,22)},function(e,t,s){e.exports=s.dlbpr(1,5)},function(e,t,s){e.exports=s.dlbpr(1,14)},function(e,t,s){e.exports=s.dlbpr(1,20)},function(e,t,s){e.exports=s.dlbpr(1,81)},function(e,t,s){e.exports=s.dlbpr(1,31)},function(e,t,s){e.exports=s.dlbpr(1,85)},function(e,t,s){e.exports=s.dlbpr(1,80)},,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,function(e,t,s){"use strict";s.r(t);const r="0.0.9",n="live-notifications";class i extends Error{constructor({message:e,details:t}){super(e);this.details={};this.name="LiveNotificationsError";"captureStackTrace"in Error&&Error.captureStackTrace(this,this.constructor);this.details=t||{}}}const a="LIVE_NOTIFICATIONS_DEBUG";let o=!1;const c={localClient:!1,messageDebug:!1,localEmbed:!1,debugUnsupportedClient:!1},d=()=>{if(o)return c;try{if(localStorage&&"true"===localStorage.getItem(a)){c.localClient=!0;c.messageDebug=!0;c.localEmbed=!0;c.debugUnsupportedClient=!1;o=!0;return c}const e=localStorage&&JSON.parse(localStorage.getItem(a)||"{}");if(e){const{localClient:t,messageDebug:s,localEmbed:r,debugUnsupportedClient:n}=e;c.localClient=!0===t;c.messageDebug=!0===s;c.localEmbed=!0===r;c.debugUnsupportedClient=!0===n}o=!0;return c}catch(e){o=!0;return c}};let l=void 0;const h=()=>{if(void 0!==l)return l;const e=window.location.host;l=e.startsWith("local")&&!e.includes("hsappstatic");return l},g=e=>e&&e.xhr,u=(e,{extraData:t,fingerprint:s,tags:r,level:n}={})=>{const i=window.newrelic;if(t&&t.error&&g(t.error)){t.status=t.error.status;t.statusText=t.error.statusText;delete t.error}i&&"function"==typeof i.noticeError&&"info"!==n&&i.noticeError(e,r||{});const a=window.Raven;a&&"function"==typeof a.captureException&&a.captureException(e,{fingerprint:s,tags:r||{},extra:t,level:n});d().messageDebug&&console.error(e,t)},p=/(?:(?:app(?:-[a-z]{0,2}\d)?)|(?:local))\.hubspot(?:qa)?\.com/,E=(e="")=>{let t,s="";for(let e=0;e<32;e++){t=16*Math.random()|0;8!==e&&12!==e&&16!==e&&20!==e||(s+="-");s+=(12===e?4:16===e?3&t|8:t).toString(16)}return`${e}_${s}`},m=e=>"__shared-worker-versioning-embed-message--"+e,_=e=>({format:m(e),id:E(e)});let I;!function(e){e.TO_EMBED="TO_EMBED";e.FROM_EMBED="FROM_EMBED";e.EMBED_READY="EMBED_READY";e.EMBED_INIT_FAILED="EMBED_INIT_FAILED";e.EMBED_WORKER_CONNECTION_STATUS_UPDATE="EMBED_WORKER_CONNECTION_STATUS_UPDATE"}(I||(I={}));const b=(e,t)=>{const s=m(t);return Boolean(e&&e.id&&e.format===s)},T=e=>Boolean(e.type&&e.type===I.TO_EMBED),y=(e,t)=>Object.assign({},_(e),{type:I.FROM_EMBED,message:t}),f=(e,t)=>Object.assign({},_(e),{type:I.EMBED_READY,payload:t}),v=(e,t)=>Object.assign({},_(e),{type:I.EMBED_INIT_FAILED,payload:t}),S=(e,t,s)=>Object.assign({},_(e),{type:I.EMBED_WORKER_CONNECTION_STATUS_UPDATE,payload:{appData:t,status:s}});function M(e){let t,s=!1;return function(...r){if(!s){s=!0;t=e.apply(this,r)}return t}}const R=(e,t,s=window)=>{s.parent.postMessage(e,t)},C=M((e,t=window)=>!t.parent||!e);class O{constructor(e){this._handleMessage=e=>{if(!(e.origin.match(p)&&e.data&&e.data.message&&b(e.data,this._options.embedName)&&T(e.data)))return;const{data:{message:t}}=e;this._options.onParentMessage(t)};this.sendEmbedReadyMessage=e=>{const{parentOrigin:t,embedName:s,logClientDebug:r}=this._options;if(C(t))return;const n=f(s,e);r("Sending message to embed host "+n.type,n);R(n,t)};this.sendFromEmbedMessage=e=>{const{parentOrigin:t,embedName:s,logClientDebug:r}=this._options;if(!C(t)){r("Sending message to embed host "+e.type,e);R(y(s,e),t)}};this.sendWorkerConnectionStatusUpdateMessage=(e,t)=>{const{parentOrigin:s,embedName:r,logClientDebug:n}=this._options;if(!C(s)){n(`Sending message to embed host ${I.EMBED_WORKER_CONNECTION_STATUS_UPDATE}, status: ${e}`);R(S(r,t,e),s)}};this.sendEmbedInitializationFailedMessage=e=>{const{parentOrigin:t,embedName:s,logClientDebug:r}=this._options;r("Sending message to embed host "+I.EMBED_INIT_FAILED,e);O.sendEmbedInitializationFailedMessage(s,t,e)};this._options=e;window.addEventListener("message",this._handleMessage,!1)}}O.sendEmbedInitializationFailedMessage=(e,t,s)=>{if(C(t))return;const r=v(e,s);R(r,t)};var k=s(0),A=s.n(k),w=s(2),D=s.n(w);let N;function W(){return N?Promise.resolve(N):A()().then(e=>{N=e;D.a.setUserContext({id:e.user.user_id,email:e.user.email,locale:e.user.locale});return e})}const P="REPORT_WORKER_ERROR";function U(e){return e&&e.type===P}const L="__live_notifications_message";let B;!function(e){e.ToServiceWorker="ToServiceWorker";e.FromServiceWorker="FromServiceWorker";e.ToWebWorker="ToWebWorker";e.FromWebWorker="FromWebWorker"}(B||(B={}));const V="WEBWORKER_APPDATA_RESPONSE",F="OBTAIN_ABLY_AUTH_KEY_RESPONSE",$="NOTIFICATION_STATUS_UPDATE",j="PRESENCE_RESPONSE",K="PRIMARY_CLIENT_HEARTBEAT_RESPONSE",x="CTA_REQUEST_MESSAGE",z="CTA_RESPONSE_MESSAGE";function q(e){return Boolean(e&&e.metadata&&e.metadata.messageRelay===B.ToWebWorker)}const G=e=>e&&e.type===x,H=e=>e&&e.type===z,Y=[];function J(){let e="#";for(let t=0;t<3;t++)e+=("0"+Math.floor((1+Math.random())*Math.pow(16,2)/2).toString(16)).slice(-2);return e}class Q{constructor(e){this._color=J();this.log=(...e)=>{const t=new Date;let s=`%c${t.getHours()}:${t.getMinutes()}:${t.getSeconds()} [${this._prefix}]: `;if(console.groupCollapsed&&e.length>1){const[t,...r]=e;if(Array.isArray(t)){const[e,r]=t;s+=e;console.groupCollapsed(s,`color:${this._color};`,r)}else{s+=t;console.groupCollapsed(s,`color:${this._color};`)}Y.push(s);Y.concat(r);console.log(...r);console.groupEnd();return}const[r,...n]=e;s+=r;console.log(s,`color:${this._color};`,...n);Y.push(s);Y.concat(n)};this._prefix=e}}const Z=n+"-embed";let X=void 0,ee=!1;const te=()=>{if(ee)return X;ee=!0;try{if(d().messageDebug){X=new Q(Z).log;return X}}catch(e){}},se=(...e)=>{const t=te();t&&t(...e)};var re=s(3),ne=s.n(re);const ie="/live-notifications-embed",ae=`${ie}/${ne.a.get()}/`,oe=ae+"service-worker.js",ce=ie+"/shared-worker.js",de=ie+"/web-worker.js",le=M(()=>Boolean(window.SharedWorker)&&Boolean(window.BroadcastChannel));let he=window.navigator?navigator.userAgent.toLowerCase():"";const ge=()=>he.includes("edge/"),ue=()=>he.includes("safari/")&&!he.includes("chrome/")&&!ge(),pe=M(()=>{let e=!1===le()||ue();try{d().debugUnsupportedClient&&(e=!0)}catch(e){}return e}),Ee=({name:e,workerVersion:t,portalId:s})=>{let r=e;s&&(r+="#"+s);t&&(r+="@"+t);return r};function me(){let e=()=>{},t=()=>{};return{promise:new Promise((s,r)=>{e=s;t=r}),resolve:e,reject:t}}var _e=me;const Ie=2e4;let be;!function(e){e.MESSAGE_RECIEVED="MESSAGE_RECIEVED";e.MESSAGE_TIMEOUT="MESSAGE_TIMEOUT";e.MESSAGE_ERROR="MESSAGE_ERROR"}(be||(be={}));function Te(e){return e.status===be.MESSAGE_RECIEVED}function ye({port:e,message:t,errorAckMessageType:s,timeout:r}){if(!(t.type&&t.originConnectionId&&t.responseRequest&&t.responseRequest.type))return Promise.resolve({status:be.MESSAGE_ERROR,responseMessageType:t&&t.responseRequest&&t.responseRequest.type||"unknown",errorMessage:`Send Ack requires a type an originConnectionId and responseRequest info, recieved: ${t.type}, ${t.originConnectionId}`});const n=t.responseRequest.type;let i="Never received message type "+n;const a=_e(),o=()=>new Promise(e=>setTimeout(()=>{e({status:be.MESSAGE_TIMEOUT,responseMessageType:n,errorMessage:i})},"number"==typeof r?r:Ie)),c=e=>{if(Boolean(e.data)&&(e.data.type===n||s&&e.data.type===s))if(e.data.responseRequest.requestId!==t.id||e.data.destinationConnectionId!==t.originConnectionId)i=`Recieved Message ${n} with non-matching requestId: ${e.data.responseRequest.requestId===t.id} or connectionId: ${e.data.destinationConnectionId===t.originConnectionId} error`;else{if(e.data.type===n){a.resolve({status:be.MESSAGE_RECIEVED,responseMessageType:n,messageEvent:e});return}a.resolve({status:be.MESSAGE_ERROR,responseMessageType:n,messageEvent:e})}else i=`Never received message type ${n}, Last message type is ${e.data&&e.data.type||"unknown"}`};e.addEventListener("message",c);try{e.postMessage(t)}catch(e){return Promise.resolve({status:be.MESSAGE_ERROR,responseMessageType:n,errorMessage:`Failed to send postMessage for sync message ${t.type} reason: ${e.message}`})}return Promise.race([o(),a.promise]).then(t=>{e.removeEventListener("message",c);return t})}function fe(e){let t=null;try{let s;try{s=new Blob([`importScripts('${e.url}');`],{type:"application/javascript"})}catch(e){return{error:e,worker:null}}const r=(window.URL||window.webkitURL).createObjectURL(s);t=new Worker(r,{name:e.name,credentials:"include"})}catch(e){return{error:e,worker:null}}return{worker:t,error:null}}function ve({url:e,name:t}){if(!e.startsWith("http"))throw new Error("Supplied worker url must be absolute");let s={worker:null,error:null};try{s.worker=new Worker(e,{name:t,credentials:"include"});s.worker.onerror=function(r){r.preventDefault();s=fe({url:e,name:t})}}catch(r){s=fe({url:e,name:t})}return s}var Se=s(4),Me=s(5);const Re=M(()=>{const e=Object(Me.parse)(window.location.search.substring(1));return{connectionId:e.connectionId,parentOrigin:decodeURIComponent(e.parentOrigin)}});function Ce(e,t){if(null==e)return{};var s,r,n={},i=Object.keys(e);for(r=0;r<i.length;r++){s=i[r];t.indexOf(s)>=0||(n[s]=e[s])}return n}function Oe({type:e,name:t,version:s}){return{type:e,format:t+"_shared-worker-versioning",id:E(`${t}_${e}`),version:s}}const ke="REGISTER_PORT_CONNECTION_ACK",Ae="REGISTER_PORT_CONNECTION_ACK_FAILED",we="HEARTBEAT_REQUEST",De="PORT_CONNECTION_COMPLETE",Ne=e=>e&&e.type===we;function We(e){return e&&e.type===ke}function Pe(e){return e&&e.type===Ae}function Ue(e){return e&&e.type===De}const Le="REGISTER_PORT_CONNECTION",Be="UN_REGISTER_PORT_CONNECTION",Ve="HEARTBEAT_RESPONSE";const Fe=({name:e,requestId:t,version:s})=>Object.assign({},Oe({type:Ve,name:e,version:s}),{destinationConnectionId:we,responseRequest:{requestId:t}});function $e(e){let{name:t,originConnectionId:s,appDataVersion:r,portalId:n}=e,i=Ce(e,["name","originConnectionId","appDataVersion","portalId"]);return Object.assign({},Oe({name:t,type:Le,version:r}),{originConnectionId:s,responseRequest:{type:ke},payload:Object.assign({appDataVersion:r,portalId:n},i)})}const je=({originConnectionId:e,appDataVersion:t,name:s})=>Object.assign({},Oe({type:Be,name:s,version:t}),{originConnectionId:e,payload:{appDataVersion:t,name:s}});class Ke{constructor({onMessageError:e,onMessage:t}){this.type=Ke.type;this._portalId=""+ne.a.get();this._worker=null;this._handleWorkerMessage=e=>{e&&e.data&&this._onMessage(e)};this._connectWebWorkerPort=()=>{const e=Ee({portalId:this._portalId,name:"live-notifications-fallback-worker",workerVersion:r}),t=h()?"local":"app",s=ve({url:`${Object(Se.getFullUrl)(t)}${de}`,name:e});if(s.error||!s.worker)return s;s.worker.onmessage=this._handleWorkerMessage;s.worker.onmessageerror=e=>{this._onMessageError(new Error("Message Error in Shared Worker Port"),{error:e})};return s};this._handleWorkerConnected=()=>{const e=Re().connectionId;return ye({port:this._worker,message:$e({name:n,originConnectionId:e,appDataVersion:r,portalId:this._portalId})}).then(e=>{if(!Te(e)||!e.messageEvent||e.messageEvent instanceof Error)throw new Error(`Live notifications worker not initialized ${e.responseMessageType} never recieved.`);const{data:t}=e.messageEvent;return t.payload})};this.sendMessage=e=>{if(this._worker)try{this._worker.postMessage(e)}catch(t){this._onMessageError(new Error(`Error sending message ${e.type} in web worker`))}else{const t=new i({message:`unable to send message ${e.type}, missing worker port and message queue was skipped`});this._onMessageError(t)}};this._onMessageError=e;this._onMessage=t}connect(){try{const e=this._connectWebWorkerPort();if(e.error||!e.worker)throw e.error||new Error("Web Worker not available");this._worker=e.worker;return}catch(e){return e}}initialize(){if(window.Worker){se("Initializing Unsupported Messaging Client");const e=this.connect();if(e)return Promise.reject(e);if(this._worker)return this._handleWorkerConnected()}return Promise.reject(new i({message:"Web Workers are not available"}))}}Ke.type="UNSUPPORTED_CLIENT";let xe;!function(e){e.WEB_WORKER="Web";e.SHARED_WORKER="Shared"}(xe||(xe={}));function ze(e){return{responseRequest:{},payload:{},format:L,id:E(L),metadata:{messageRelay:e}}}const qe=(e,t,s)=>Object.assign({},ze(B.ToWebWorker),{type:F,payload:s,destinationConnectionId:t,responseRequest:{requestId:e}}),Ge=(e,t,s)=>Object.assign({},ze(B.ToWebWorker),{type:V,originConnectionId:s,payload:{notifications:e,serviceWorkerClientId:t}}),He=({identity:e,subtypeAction:t,subtypeReason:s,userAction:r,errorDescription:n})=>Object.assign({},ze(B.ToWebWorker),{type:$,payload:{identity:e,subtypeAction:t,subtypeReason:s,userAction:r,errorDescription:n}}),Ye=({is403:e,requestId:t,token:s})=>Object.assign({},ze(B.ToWebWorker),{destinationConnectionId:B.FromWebWorker,type:j,payload:{token:s,is403:Boolean(e)},responseRequest:{requestId:t}}),Je=(e,t)=>Object.assign({},ze(B.ToWebWorker),{type:K,destinationConnectionId:B.FromWebWorker,responseRequest:{requestId:e},payload:{visibilityState:t}});var Qe=s(6),Ze=s(7),Xe=s.n(Ze),et=s(8),tt=s(9),st=s.n(tt);const rt=Xe()(Object(Qe.createStack)(st.a,Object(et.retry)(e=>!e||!e.data||![200,403,401,0].includes(e.status),{delay:1e3,maxRetries:3}))),nt="notification-station/general/v1/ably/token-request";function it(e,t){return rt.get(nt,{portalId:ne.a.get()}).then(({ablyKey:s,tokenRequest:r})=>{e(qe(t.id,t.originConnectionId,{ablyDecryptionKeys:s,token:r}))}).catch(s=>{"number"!=typeof s.status?u(s):Fs.shouldMaintainPresence&&u(new i({message:"Ably Auth Token request failed "+s.status}),{level:"info"});e(qe(t.id,t.originConnectionId,{ablyDecryptionKeys:void 0,token:void 0}))})}var at=s(1),ot=s.n(at);const ct=()=>({enviro:{hublet:ot.a.getHublet(),short:ot.a.getShort()},shouldMaintainPresence:Fs.shouldMaintainPresence}),dt="NOTIFICATION_UPDATES",lt="OBTAIN_ABLY_AUTH_KEY_REQUEST",ht="TRACK_WORKER_METRIC",gt="PRESENCE_REQUEST",ut="PRIMARY_CLIENT_HEARTBEAT",pt="PRIMARY_CLIENT_UPDATE",Et=e=>Boolean(e&&e.metadata&&e.metadata.messageRelay&&e.metadata.messageRelay===B.FromWebWorker),mt=e=>e&&e.type===dt,_t=e=>e&&e.type&&e.type===lt,It=e=>e&&e.type&&e.type===ht,bt=e=>e&&e.type&&e.type===gt,Tt=e=>e&&e.type&&e.type===pt,yt=e=>e&&e.type&&e.type===ut,ft="WEBWORKER_APPDATA_REQUEST",vt="CLIENT_REGISTRATION",St=e=>e&&e.type===ft;function Mt(e){return Boolean(e&&e.metadata&&e.metadata.messageRelay===B.ToServiceWorker)}let Rt,Ct,Ot,kt,At;!function(e){e.CALLING="CALLING"}(Rt||(Rt={}));!function(e){e.SHOW_NOTIFICATION="SHOW_NOTIFICATION";e.UPDATE_NOTIFICATION="UPDATE_NOTIFICATION";e.REMOVE_NOTIFICATION="REMOVE_NOTIFICATION"}(Ct||(Ct={}));!function(e){e.UNINITIALIZED="UNINITIALIZED";e.CTA_RESPONSE_REQUESTED="CTA_RESPONSE_REQUESTED";e.CTA_RESPONSE_ERROR="CTA_RESPONSE_ERROR"}(Ot||(Ot={}));!function(e){e.STRING="STRING";e.TRANSLATABLE="TRANSLATABLE";e.DELIVERY_DATA="DELIVERY_DATA";e.ID_DATA="ID_DATA";e.URL="URL";e.CONTACT="CONTACT";e.COMPANY="COMPANY";e.USER="USER";e.DEAL="DEAL";e.TICKET="TICKET";e.QUOTE="QUOTE";e.JSON="JSON";e.PUBLIC_DELIVERY_DATA="PUBLIC_DELIVERY_DATA";e.NUMBER="NUMBER";e.FLAG="FLAG";e.CONTEXTUAL_DATA="CONTEXTUAL_DATA"}(kt||(kt={}));!function(e){e.CALLING_INBOUND_CALL_NOTIFICATION="CALLING_INBOUND_CALL_NOTIFICATION"}(At||(At={}));const wt="CLIENT_REGISTRATION_RESPONSE",Dt=e=>e&&e.metadata&&e.metadata.messageRelay&&e.metadata.messageRelay===B.FromServiceWorker,Nt=e=>e&&e.type===wt,Wt=()=>Object.assign({},ze(B.ToServiceWorker),{type:vt,payload:{messageDebug:d().messageDebug}}),Pt=e=>Object.assign({},ze(B.ToServiceWorker),{type:ft,payload:{serviceWorkerClientId:e}});var Ut=s(10);const Lt=M(()=>Object(Ut.createMetricsFactory)("live-notifications",{dimensions:{has_shared_worker_support:""+le()}}));function Bt(e){const t=Lt(),{type:s,metric:r,dimensions:n,time:i}=e.payload;"timer"===s?t.timer(r,n).update(i||0):"counter"===s&&t.counter(r,n).increment()}const Vt=M(()=>Boolean(navigator&&navigator.serviceWorker)),Ft=()=>Vt()?navigator.serviceWorker.register(oe,{scope:ae}):Promise.reject(new i({message:"Service Worker is unsupported"})),$t=e=>{Vt()&&navigator.serviceWorker.addEventListener("message",e)},jt=e=>{Vt()&&navigator.serviceWorker.ready.then(t=>{if(t&&t.active){se(`Sending ${e.type} message through ServiceWorker`,e);t.active.postMessage(e)}else u(new i({message:`service worker registration is not available, message ${e.type} was not sent`}),{extraData:{message:e,waiting:t.waiting,installing:t.installing},level:"info"})}).catch(()=>{})};class Kt{constructor(){this.isInitialized=!1;this._swInitDeferred=_e();this._handleWorkerDataPropegation=e=>{e.payload.serviceWorkerClientId&&this.sendMessage(Ge(Fs.getAppData(),e.payload.serviceWorkerClientId,Re().connectionId))};this._handleServiceWorkerMessage=e=>{const{data:t}=e;if(!Dt(t)&&!q(t))return;const s=t;se("Recieved Message from Service Worker "+s.type,s);if((G(s)||H(s))&&s.metadata.messageRelay===B.FromServiceWorker){Lt().counter("recieved-cta-from-service-worker").increment();Ht.sendFromEmbedMessage(s)}else if(Nt(s)){this.swClientId=s.payload.clientId;this._swInitDeferred.resolve(void 0)}else St(s)?this._handleWorkerDataPropegation(s):q(s)&&!Fs.getIsSharedWorkerClient()&&Fs.sendMessage(s)};this.sendMessage=e=>{jt(e)}}initialize(){this.isInitialized=!0;$t(this._handleServiceWorkerMessage);Ft().then(()=>{se("Live Notifications Service Worker registered");this.sendMessage(Wt())}).catch(e=>{this._swInitDeferred.reject(new i({message:"Failed to initialize ServiceWorkerConnection reason: "+(e&&e.message||"unknown reason"),details:{error:e}}))});return this._swInitDeferred.promise}}var xt=new Kt;const zt=e=>{G(e)&&zt(He({identity:e.payload.notificationIdentity,userAction:Ot.CTA_RESPONSE_REQUESTED}));Fs.sendMessage(e);Fs.getIsSharedWorkerClient()||xt.sendMessage(e)},qt=e=>{xt.sendMessage(e)},Gt=e=>{q(e)?zt(e):Mt(e)&&qt(e)},Ht=new O({embedName:n,parentOrigin:Re().parentOrigin,onParentMessage:Gt,logClientDebug:se});var Yt=s(11),Jt=s.n(Yt),Qt=s(12),Zt=s.n(Qt);function Xt(e,t){return`/presence/v1/presence/portal/${e}/user/${t}`}function es(e){return"/presence/v1/presence?portalId="+e}class ts{constructor(){this._logError=(e,t)=>{const s={error:e};e&&e.xhr&&(s.error={status:e.status,message:e.message,statusText:e.statusText});u(new i({message:t}),{extraData:s})};this._validateAuth=e=>{if(!e||!e.user)throw new i({message:"Auth Error in NoAuth Presence Util, no user found"});return e};this._callNoAuthPresenceEndpoint=(e,t)=>W().then(this._validateAuth).then(t=>Jt.a.put(Xt(t.portal.portal_id,t.user.user_id),{data:{token:e}})).then(()=>Ye({token:e,requestId:t})).catch(e=>{if(e&&0!==e.status){if(401===e.status)return this._callAuthPresenceEndpoint(t);this._logError(e,"Error getting presence token from NoAuth API")}return Ye({requestId:t})});this._callAuthPresenceEndpoint=e=>W().then(this._validateAuth).then(e=>Zt.a.put(es(e.portal.portal_id))).then(t=>Ye({requestId:e,token:t})).catch(t=>{if(t&&t.status&&[401,403].includes(t.status))return Ye({requestId:e,is403:!0});this._logError(t,"Error getting presence token from Auth API");return Ye({requestId:e})});this.ping=(e,t)=>t?this._callNoAuthPresenceEndpoint(t,e):this._callAuthPresenceEndpoint(e)}}var ss=new ts;function rs(e){let t;try{t=localStorage.getItem(e)}catch(e){}return t}function ns(){const e="CROSS_TAB_TEST_KEY";let t=!!window.localStorage;if(t)try{localStorage.setItem(e,"");localStorage.removeItem(e)}catch(e){t=!1}return t}const is="CROSS_TAB",as="CROSS_TAB_DEBUG";function os(){return"true"===rs(as)}function cs(e,t){if(os()){const s=`${is} - ${e}`;t?console.debug(s,t):console.debug(s)}}function ds(e){return`${e}-${Date.now()}-${Math.random().toFixed(10).substr(2)}`}class ls{constructor(){this.callbacks={}}addEventListener(e,t){this.callbacks[e]||(this.callbacks[e]=[]);this.callbacks[e].push(t)}removeEventListener(e,t){this.callbacks[e]=this.callbacks[e].filter(e=>e!==t)}trigger(e,...t){this.callbacks[e]&&this.callbacks[e].forEach(e=>e(...t))}}class hs{constructor(e){this.handleStorageEvent=this.handleStorageEvent.bind(this);this.eventManager=new ls;this.namespace="";e||!ns()?this.storage=e||{}:window.addEventListener("storage",this.handleStorageEvent)}setNamespace(e){this.namespace=e}setKey(e,t){this.storageKey=e;this.storageSubKey=t}getNamespacedKey(e){return this.namespace?`${this.namespace}-${e}`:e}getItem(e){try{const t=this.getNamespacedKey(e);return this.storage?this.storageKey?this.storage[this.storageKey][this.storageSubKey][t]:this.storage[t]:this.storageKey?JSON.parse(localStorage.getItem(this.storageKey))[this.storageSubKey][t]:JSON.parse(localStorage.getItem(t))}catch(e){cs("Error while reading localStorage value:",e);return null}}setItem(e,t){const s=this.getNamespacedKey(e),r=this.storageKey||s;let n=t;if(this.storageKey){let e;try{e=this.storage?this.storage[this.storageKey][this.storageSubKey]:JSON.parse(localStorage.getItem(this.storageKey))[this.storageSubKey]}catch(t){cs("Error while writing localStorage value:",t);e={}}n={[this.storageSubKey]:Object.assign({},e,{[s]:t})}}if(this.storage){this.storage[r]=n;this.eventManager.trigger(e,t)}else try{localStorage.setItem(r,JSON.stringify(n));this.eventManager.trigger(e,t)}catch(e){}}getArrayItem(e){const t=this.getItem(e);return Array.isArray(t)?t:[]}pushItem(e,t){this.setItem(e,this.getArrayItem(e).concat([t]))}removeArrayItem(e,t){this.setItem(e,this.getArrayItem(e).filter(e=>e!==t))}moveItemToFront(e,t){this.setItem(e,[t,...this.getArrayItem(e).filter(e=>e!==t)])}handleStorageEvent({key:e,newValue:t,oldValue:s}){let r;if(this.storageKey){if(e&&this.storageKey===e){r=null;try{const e=JSON.parse(s)[this.storageSubKey],n=JSON.parse(t)[this.storageSubKey];r=[...Object.keys(e),...Object.keys(n)].find(t=>JSON.stringify(e[t])!==JSON.stringify(n[t]))}catch(e){cs("Error while parsing localStorage value:",e)}}}else r=e;if(r&&r.indexOf(this.namespace)>-1){const e=r.replace(this.namespace+"-","");this.eventManager.trigger(e,this.getItem(e))}}removeItemChangeListener(e,t){this.eventManager.removeEventListener(e,t)}onItemChange(e,t){this.eventManager.addEventListener(e,t)}}const gs=1e3,us=2*gs,ps=3*gs,Es="TABS_HEARTBEAT",ms="TABS_MESSAGE",_s="TABS_LIST",Is="becomeMaster",bs="surrenderMaster",Ts="anyMessage",ys="message",fs="removed";class vs{constructor(e,t,s=new hs,r=window){this.checkMasterIsAlive=this.checkMasterIsAlive.bind(this);this.handleReceivedMessage=this.handleReceivedMessage.bind(this);this.handleUpdatedTabs=this.handleUpdatedTabs.bind(this);this.heartbeat=this.heartbeat.bind(this);this.unregister=this.unregister.bind(this);this.currentTab=ds("tab");this.storage=s;this.options=t;s.setNamespace(e);s.setKey(...t.storageKey||[]);this.eventManger=new ls;Object.keys(t).filter(e=>/^on[A-Z]/.test(e)).forEach(e=>{this[e]&&t[e]&&this[e](t[e])});this.storage.onItemChange(ms,this.handleReceivedMessage);if(!this.options.passive){this.storage.onItemChange(_s,this.handleUpdatedTabs);r.addEventListener("beforeunload",this.unregister);this.register();this.checkMasterAliveInterval=setInterval(this.checkMasterIsAlive,us)}}checkMasterIsAlive(){const e=this.getMasterTab();if(Date.now()-this.storage.getItem(Es)>ps){cs(`Master (${e}) removed due to inactivity`);this.storage.removeArrayItem(_s,e)}}didBecomeMasterTab(){cs("Tab is now master");this.eventManger.trigger(Is);this.heartbeat();this.heartbeatInterval=setInterval(this.heartbeat,gs)}register(){if(this.options.passive)cs("Tab is passive. Won't be registered");else{cs("Registered current tab with id:",this.currentTab);this.storage.pushItem(_s,this.currentTab)}}reRegister(){cs("Current tab was removed from localStorage. Re-registering");clearInterval(this.heartbeatInterval);this.eventManger.trigger(fs);this.register()}dispatchMessage(e){cs("Dispatching message:",e);this.storage.setItem(ms,{from:this.currentTab,id:ds("message"),message:e})}getMasterTab(){return this.storage.getArrayItem(_s)[0]}isCurrentTabMaster(){return this.getMasterTab()===this.currentTab}isCurrentTabInTabList(){return this.storage.getArrayItem(_s).indexOf(this.currentTab)>-1}handleReceivedMessage(e){if(e){if(e.from!==this.currentTab){cs("Received message:",e);this.eventManger.trigger(Ts,e);e.from===this.getMasterTab()&&this.eventManger.trigger(ys,e)}}else cs("Received undefined or null message. currentTab: "+this.currentTab)}handleUpdatedTabs(){const e=this.currentMasterTab,t=this.getMasterTab();this.currentMasterTab=t;if(t!==e)if(t===this.currentTab)this.didBecomeMasterTab();else{cs("Master updated:",this.getMasterTab());clearInterval(this.heartbeatInterval);this.eventManger.trigger(bs)}this.isCurrentTabInTabList()||this.reRegister()}heartbeat(){this.storage.setItem(Es,Date.now())}onBecomeMaster(e){this.eventManger.addEventListener(Is,e)}onSurrenderMaster(e){this.eventManger.addEventListener(bs,e)}onMessageFromMaster(e){this.eventManger.addEventListener(ys,e)}onMessage(e){this.eventManger.addEventListener(Ts,e)}onRemoved(e){this.eventManger.addEventListener(fs,e)}unregister(){this.storage.removeItemChangeListener(_s,this.handleUpdatedTabs);this.storage.removeArrayItem(_s,this.currentTab)}}var Ss=vs;class Ms{constructor(){this.isInitialized=!1;this.isPrimary=!1;this.updateIsPrimary=e=>{this.isPrimary=e===Re().connectionId;se("Primary Client was updated, isPrimary: "+this.isPrimary)};this.sendHeartbeatResponse=e=>{Fs.sendMessage(Je(e.id,document.visibilityState))};this.setupPrimaryTabLocalStorageManagement=()=>{const e="LIVE_NOTIFICATIONS_"+ne.a.get(),t=()=>{this.isPrimary=!0;se("Primary Client was updated, isPrimary: true")},s=()=>{this.isPrimary=!1;se("Primary Client was updated, isPrimary: false")};this._crossTab=new Ss(e,{onBecomeMaster:t,onSurrenderMaster:s,onRemoved:s})};this.initialize=()=>{if(!this.isInitialized){this.isInitialized=!0;Fs.messageClientType!==xe.SHARED_WORKER&&this.setupPrimaryTabLocalStorageManagement()}}}}var Rs=new Ms;const Cs=M(E);let Os;!function(e){e.UNINITIALIZED="UNINITIALIZED";e.STARTED="STARTED";e.SUCCEEDED="SUCCEEDED";e.FAILED="FAILED";e.DEPRECATED="DEPRECATED";e.UNSUPPORTED="UNSUPPORTED"}(Os||(Os={}));function ks({url:e,name:t}){const s={worker:null,error:null};try{s.worker=new SharedWorker(e,{name:t,credentials:"include"})}catch(e){s.error=e}return s}const As="Error From WorkerScript",ws=({url:e,workerName:t,onMessage:s,onMessageError:r,version:n})=>{const{worker:i,error:a}=ks({name:t,url:e});if(!i||a)throw a;i.addEventListener("error",e=>{r(new Error(As),{message:e.message,lineno:e.lineno,filename:e.filename})});i.port.addEventListener("message",e=>{e&&e.data&&Ne(e.data)?i.port.postMessage(Fe({name:t,requestId:e.data.id,version:n})):s(e)});i.port.addEventListener("messageerror",e=>{const t=e&&e.data?e.data:{};r(new Error("Message Error in Shared Worker Port"),{messageData:t})});i.port.start();return i},Ds=({channelName:e,onMessage:t,onMessageError:s})=>{if("function"!=typeof BroadcastChannel)return null;const r=new BroadcastChannel(e+"-version-deprecation");r.onmessage=t;r.onmessageerror=e=>{const t=e&&e.data?e.data:{};s(new Error("Message Error in Version Broadcast Channel"),{messageData:t})};return r};let Ns;!function(e){e.VERSION_DEPRECATION="VERSION_DEPRECATION"}(Ns||(Ns={}));function Ws(e,t){return Object.assign({},e,{payload:e.payload||{},originConnectionId:t})}class Ps{constructor(e){this._versionBroadcastChannel=null;this._sharedWorker=null;this._sendPortRegistration=()=>{this._debug&&this._debug("Registering connection with SharedWorker");const e=$e(Object.assign({name:this._name,originConnectionId:this._connectionId,appDataVersion:this._appDataVersion,portalId:this._portalId},this._getAdditionalRegistrationInformation()));return ye({port:this._sharedWorker.port,errorAckMessageType:Ae,message:e})};this._handleSharedWorkerInitialized=e=>{if(!(e.messageEvent&&e.messageEvent.data&&Te(e)&&We(e.messageEvent.data))){let t,s=e.errorMessage||`${e.responseMessageType} never recieved for an unknown reason, status ${e.status}.`;const r=e.messageEvent&&e.messageEvent.data;if(r&&Pe(r)){s=`${e.responseMessageType} never recieved, ${r.payload.message}`;t=r.payload.stack}throw new Error(s,{cause:t})}const{data:t}=e.messageEvent;this._debug&&this._debug("SharedWorker registration succeeded");return t.payload};this._handleWorkerBroadcastChannelMessage=e=>{if(!e.data||e.data.type!==Ns.VERSION_DEPRECATION||!e.data.payload||e.data.payload.workerVersion===this._clientVersion)return;const{payload:{workerVersion:t}}=e.data;if(this._clientVersion!==t&&this._sharedWorker&&this._versionBroadcastChannel){this._debug&&this._debug(`Recieved version deprecation message from ${this._versionBroadcastChannel.name},\n        current version is ${this._clientVersion} new version is ${t}`);this.refreshVersionedSharedWorkerClient(t)}};this.sendMessage=e=>{if(this._sharedWorker){const t=Ws(e,this._connectionId);try{this._sharedWorker.port.postMessage(t)}catch(e){this._onMessageError(new Error(`SharedWorkerMessagingClient#sendMessage error unable to send ${t.type}, reason: ${e&&e.message}`))}}else this._onMessageError(new Error(`SharedWorkerMessagingClient#sendMessage error unable to send ${e.type}, reason: shared worker does not exist`))};this.connect=()=>new Promise((e,t)=>{try{const t=Ee({portalId:this._portalId,name:this._name,workerVersion:this._clientVersion});this._versionBroadcastChannel||(this._versionBroadcastChannel=Ds({channelName:this._name,onMessage:this._handleWorkerBroadcastChannelMessage,onMessageError:this._onMessageError}));this._sharedWorker=ws({url:`${this._sharedWorkerUrl}?v=${this._clientVersion}`,workerName:t,onMessage:this._onMessage,onMessageError:this._onMessageError,version:this._appDataVersion});this._debug&&this._debug("Opened connection to SharedWorker: "+t);e(void 0)}catch(e){this._debug&&this._debug("Failed to open connection to SharedWorker",e);t(e)}});this.close=()=>{const e=je({originConnectionId:this._connectionId,appDataVersion:this._appDataVersion,name:this._name});this._sharedWorker&&this._sharedWorker.port.postMessage(e)};this.open=()=>this.connect().then(this._sendPortRegistration).then(this._handleSharedWorkerInitialized).catch(e=>{this._versionBroadcastChannel&&this._versionBroadcastChannel.close();throw e});this.refreshVersionedSharedWorkerClient=e=>{this._onVersionWorkerStatusUpdate(Os.STARTED);this._clientVersion=e;if(this._sharedWorker){this._sharedWorker.port.postMessage(je({originConnectionId:this._connectionId,name:this._name,appDataVersion:this._appDataVersion}));this._sharedWorker.port.close();this._sharedWorker=null}this._debug&&this._debug("Refreshing version, new version is "+this._clientVersion);return this.connect().then(this._sendPortRegistration).then(this._handleSharedWorkerInitialized).then(e=>{if(!e)throw new Error("WorkerRefresh failed with no data");this._onVersionWorkerStatusUpdate(Os.SUCCEEDED,e)}).catch(e=>{this._debug&&this._debug("WorkerRefresh failed",e);this._onVersionWorkerStatusUpdate(Os.FAILED);this._versionBroadcastChannel&&this._versionBroadcastChannel.close()})};const{portalId:t,connectionId:s,initialClientVersion:r,name:n,sharedWorkerUrl:i,onMessage:a,onMessageError:o,onVersionWorkerStatusUpdate:c,getAdditionalRegistrationInformation:d,appDataVersion:l,debug:h}=e;this._connectionId=s;this._portalId=t;this._appDataVersion=l;this._debug=h;this._onMessage=a;this._clientVersion=r;this._name=n;this._sharedWorkerUrl=i;this._getAdditionalRegistrationInformation=d;this._onMessageError=o;this._onVersionWorkerStatusUpdate=c}get clientVersion(){return this._clientVersion}get type(){return Ps.type}}Ps.type="SUPPORTED_CLIENT";const Us=()=>({isPortalSpecific:!0,getAdditionalRegistrationInformation:()=>({}),onDisconnect:()=>{},onMessage:()=>{},onMessageError:(e,t)=>{}}),Ls="UNSUPPORTED";class Bs{constructor(e){this._initialized=!1;this.disconnect=e=>{this._clientOptions.debug&&this._clientOptions.debug("Disconnecting from SharedWorker");e||window.removeEventListener("unload",this.disconnect);this._onDisconnect();this._client&&this._client.close()};this.sendMessage=e=>{if(this._client&&this._initialized){this._clientOptions.debug&&this._clientOptions.debug("Sending message to SharedWorker "+e.type,e);this._client.sendMessage(e)}else this._clientOptions.onMessageError(new Error("Message Client does not exist or is not ready"))};this.initialize=(e,t=Ps)=>new Promise((s,r)=>{this._initialized=!0;if(le()){this._client=new t(Object.assign({},this._clientOptions,{connectionId:e||this._clientOptions.connectionId}));window.addEventListener("unload",this.disconnect);this._client.open().then(s).catch(e=>{this._clientOptions.debug&&this._clientOptions.debug("Failed to setup SharedWorker");r(e)})}else{this._clientOptions.debug&&this._clientOptions.debug("SharedWorkers are unsupported");r(new Error("SharedWorkers are "+Ls))}});const{portalId:t,version:s,name:r,sharedWorkerUrl:n,onMessage:i,onVersionWorkerStatusUpdate:a,onDisconnect:o,onMessageError:c,getAdditionalRegistrationInformation:d,debug:l}=Object.assign({},Us(),{},e);this._appDataVersion=s;this._clientOptions={portalId:t||"",onMessage:i,onMessageError:c,initialClientVersion:s,appDataVersion:this._appDataVersion,name:r,onVersionWorkerStatusUpdate:a,getAdditionalRegistrationInformation:d,sharedWorkerUrl:n,debug:l,connectionId:Cs()};this._onDisconnect=o}get appDataVersion(){return this._appDataVersion}get connectionId(){return this._clientOptions.connectionId}get isInitialized(){return this._initialized}get clientVersion(){return this._client&&this._client.clientVersion||void 0}}class Vs{constructor(){this.messageClientType=xe.SHARED_WORKER;this.isInitialized=!1;this.shouldMaintainPresence=!1;this._appData={uuid:void 0,data:{}};this._swDetails={wasConnectionMade:!1,currentPortConnections:0};this.getIsSharedWorkerClient=()=>this.messageClientType===xe.SHARED_WORKER;this._handleMessageError=(e,t)=>{se(e);u(e,{extraData:t})};this._handleRegisterPortConnectionAck=e=>{se(`Recieved Registration Message from ${this.messageClientType} Worker`,e);this._appData=e.payload};this._handleReportErrorMessage=e=>{se(`Recieved Report Error Message from ${this.messageClientType} Worker`,e);const{error:t,extra:s}=e.payload,{metadata:r}=e,n=s||{};"details"in t&&(n.details=t.details);u(t,{extraData:Object.assign({},n,{},r||{})})};this._handleToClientFromWorkerMessage=e=>{se(`Recieved Message from ${this.messageClientType} Worker ${e.type}`,e);if(G(e)||H(e))Ht.sendFromEmbedMessage(e);else{if(_t(e)){it(this.sendMessage,e);return}if(It(e)){Bt(e);return}bt(e)&&ss.ping(e.id,e.payload.token).then(e=>{this.sendMessage(e)}).catch(()=>{this.sendMessage(Ye({requestId:e.id}))})}if(mt(e)){this._appData=e.payload.appData;e.payload.isPrimaryClient=Rs.isPrimary}Ht.sendFromEmbedMessage(e)};this._handleMessage=e=>{const{data:t}=e;Ue(t)?this._swDetails={wasConnectionMade:!0,currentPortConnections:t.payload.connectionTotal}:We(t)?this._handleRegisterPortConnectionAck(t):U(t)?this._handleReportErrorMessage(t):Tt(t)?Rs.updateIsPrimary(t.payload.primaryConnectionId):yt(t)?Rs.sendHeartbeatResponse(t):G(t)||H(t)?Ht.sendFromEmbedMessage(t):Et(t)&&this._handleToClientFromWorkerMessage(t)};this.sendMessage=e=>{this._messageClient.sendMessage(e)};this.handleVersionWorkerStatusUpdate=(e,t)=>{t&&(this._appData=t);Ht.sendWorkerConnectionStatusUpdateMessage(e,this._appData)};this.initializeUnsupportedWorker=()=>{this.messageClientType=xe.WEB_WORKER;this._messageClient=new Ke({onMessageError:this._handleMessageError,onMessage:this._handleMessage});return this._messageClient.initialize()};this._messageClient=new Bs({debug:se,portalId:""+ne.a.get(),version:r,name:n,sharedWorkerUrl:ce,onMessage:this._handleMessage,onVersionWorkerStatusUpdate:this.handleVersionWorkerStatusUpdate,onMessageError:this._handleMessageError,getAdditionalRegistrationInformation:ct})}getAppData(){return this._appData}initialize(e){if(this.isInitialized)return Promise.resolve();this.isInitialized=!0;this.shouldMaintainPresence=e.gates.includes("LiveNotifications:PresencePolling");return pe()?this.initializeUnsupportedWorker().then(e=>{Rs.initialize();return e}).catch(e=>{u(e)}):this._messageClient.initialize(Re().connectionId).then(e=>{Rs.initialize();return e}).catch(e=>{throw new i({message:"Failed to initialize SharedWorkerConnection, "+(e&&e.message||"unknown reason"),details:Object.assign({error:e},this._swDetails)})})}}var Fs=new Vs;class $s{constructor(){this.startCrossTabServices=e=>{const t=xt.initialize().catch(e=>e);return Promise.all([Fs.initialize(e)]).then(([e])=>{if(!e)throw new i({message:"AppData not recieved",details:{appData:e}});return Fs.getIsSharedWorkerClient()?{appData:e,error:void 0}:t.then(t=>({appData:e,error:t}))}).then(({appData:e,error:t})=>{if(t)throw t;Ht.sendEmbedReadyMessage(e);Fs.getIsSharedWorkerClient()||xt.sendMessage(Pt());performance&&"function"==typeof performance.now&&Lt().timer("embed-initialized").update(performance.now())}).catch(e=>{Lt().counter("embed-failed").increment();throw e})}}start(){return W().then(this.startCrossTabServices).catch(e=>{const t=new i({message:"Live Notifications embed setup failed, detail: "+e.message,details:{message:e.message}});if(e&&!e.xhr&&!e.message.includes("unsupported")){let s="LiveNotificationsError"===e.name?"LIVE_NOTIFICATIONS_ERROR":"GENERIC_ERROR";const r=Fs._swDetails.wasConnectionMade?"CONNECTED_TO_SW":"NOT_CONNECTED_TO_SW";e.message.includes(ke)&&(s=ke+"_ERROR");u(t,{extraData:{error:e},fingerprint:[s,r]})}Ht.sendEmbedInitializationFailedMessage()})}}try{(new $s).start()}catch(e){u(new i({message:"Failed to call App#start"}),{extraData:{error:e}});O.sendEmbedInitializationFailedMessage(n,Re().parentOrigin)}}]);
//# sourceMappingURL=project.js.map